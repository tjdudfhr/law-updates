<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>법령 업데이트</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 16px; }
    header { margin-bottom: 16px; }
    .meta { color: #666; font-size: 12px; }
    .error { color: #b00020; }
    ul { list-style: none; padding: 0; }
    li { border: 1px solid #eee; border-radius: 8px; padding: 12px; margin: 8px 0; }
    h3 { margin: 0 0 8px; font-size: 16px; }
    .summary { color: #333; white-space: pre-line; }
    .date { color: #555; font-size: 12px; margin-top: 6px; }
  </style>
</head>
<body>
  <header>
    <h1>법령 업데이트</h1>
    <div class="meta" id="updated"></div>
  </header>
  <main>
    <div id="msg" class="meta">데이터를 불러오는 중…</div>
    <ul id="list"></ul>
  </main>
  <script>
    function tsToLocal(ts) {
      if (!ts) return "";
      const d = new Date(ts * 1000);
      return d.toLocaleString();
    }
    function stripHtml(s) { return (s || "").replace(/<[^>]+>/g, "").trim(); }
    async function load() {
      const url = "./index.json?v=" + Date.now(); // 캐시 방지
      const msg = document.getElementById("msg");
      const list = document.getElementById("list");
      const updated = document.getElementById("updated");

      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error("index.json 응답이 정상이 아닙니다: " + res.status);
        const data = await res.json();

        updated.textContent = data.generatedAt
          ? "업데이트 시각: " + tsToLocal(data.generatedAt)
          : "";

        list.innerHTML = "";
        const items = Array.isArray(data.items) ? data.items : [];
        if (items.length === 0) {
          msg.textContent = "현재 표시할 항목이 없습니다. 잠시 후 새로고침해 보세요.";
          return;
        }
        msg.textContent = "";

        items.forEach(it => {
          const li = document.createElement("li");
          const a = document.createElement("a");
          a.href = (it.source && it.source.url) ? it.source.url : "#";
          a.target = "_blank";
          a.rel = "noopener";
          a.textContent = it.title || "(제목 없음)";

          const h3 = document.createElement("h3");
          h3.appendChild(a);

          const sum = document.createElement("div");
          sum.className = "summary";
          sum.textContent = stripHtml(it.summary || "");

          const date = document.createElement("div");
          date.className = "date";
          const eff = it.effectiveDate ? `시행일: ${it.effectiveDate}` : "";
          const ann = it.announcedDate ? `공고일: ${it.announcedDate}` : "";
          date.textContent = [eff, ann].filter(Boolean).join("  |  ");

          li.appendChild(h3);
          if (sum.textContent) li.appendChild(sum);
          if (date.textContent) li.appendChild(date);

          list.appendChild(li);
        });
      } catch (e) {
        msg.className = "meta error";
        msg.textContent = "데이터를 불러오지 못했습니다. 1분 뒤 새로고침해 보세요. (" + e.message + ")";
      }
    }
    load();
  </script>
</body>
</html>
